/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/GUIForms/JDialog.java to edit this template
 */
package vistas;

import com.formdev.flatlaf.FlatDarculaLaf;
import java.awt.Color;
import utiles.SesionUtil;
import vistas.admin.AdminPanel;

/**
 *
 * @author Villegas Velázquez Alejandro
 */
public class Registro extends javax.swing.JDialog {
    private Color originalBackgroundColor;
    private final Color moradoAdmin = new Color(51, 0, 102);
    /**
     * Creates new form Registro
     */
    public Registro(java.awt.Frame parent, boolean modal) {
        super(parent, modal);
        initComponents();
        this.getRootPane().setDefaultButton(registrarButton);
        if (SesionUtil.isLoggedIn() && SesionUtil.getUsuarioActual() != null && SesionUtil.getUsuarioActual().getRol().equalsIgnoreCase("admin")) {
            rolLabel.setVisible(true);
            seleccionarRolComboBox.setVisible(true);
            volverAdminPanelButton.setVisible(true);
        } else {
            rolLabel.setVisible(false);
            seleccionarRolComboBox.setVisible(false);
            volverAdminPanelButton.setVisible(false);
        }
    }

    private void registrarUsuario() {
        // Obtener los datos de los campos de texto
        String username = UsuarioTextField.getText().trim();
        String email = correoTextField.getText().trim();
        String contrasena = new String(contraseñaTextField.getPassword());
        String rol;
        if (seleccionarRolComboBox.isVisible()) {
            // Si el ComboBox es visible (lo abrió un admin), usa el rol seleccionado
            rol = (String) seleccionarRolComboBox.getSelectedItem();
        } else {
            // Si el ComboBox no es visible (registro normal), asigna "cliente" por defecto
            rol = "cliente"; 
        }

        // Validar que no estén vacíos
        if (username.isEmpty() || email.isEmpty() || contrasena.isEmpty()) {
            javax.swing.JOptionPane.showMessageDialog(this,
                    "Por favor, complete todos los campos.",
                    "Campos vacíos",
                    javax.swing.JOptionPane.WARNING_MESSAGE);
            return;
        }

        // Validación del correo
        if (!email.contains("@")) {
            javax.swing.JOptionPane.showMessageDialog(this,
                    "El formato del correo electrónico no es válido.",
                    "Correo inválido",
                    javax.swing.JOptionPane.ERROR_MESSAGE);
            return;
        }

        // Crear un nuevo objeto Usuario con el rol
        modelos.Usuario nuevoUsuario = new modelos.Usuario();
        nuevoUsuario.setNombre(username);
        nuevoUsuario.setEmail(email);
        nuevoUsuario.setContrasena(contrasena);
        nuevoUsuario.setRol(rol);

        // Llamar al controlador para agregar el usuario
        try {
            controladores.UsuarioController controller = new controladores.UsuarioController();
            controller.agregarUsuario(nuevoUsuario);

            javax.swing.JOptionPane.showMessageDialog(this,
                    "Usuario registrado correctamente como: " + rol,
                    "Registro exitoso",
                    javax.swing.JOptionPane.INFORMATION_MESSAGE);
            Login nuevoLogin = new Login(null, true);
            nuevoLogin.setVisible(true);

            dispose(); // Cerrar el diálogo
        } catch (Exception e) {
            javax.swing.JOptionPane.showMessageDialog(this,
                    "Error al registrar usuario: " + e.getMessage(),
                    "Error",
                    javax.swing.JOptionPane.ERROR_MESSAGE);
        }
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        UsuarioLabel = new javax.swing.JLabel();
        contraseñaLabel = new javax.swing.JLabel();
        correoLabel = new javax.swing.JLabel();
        UsuarioTextField = new javax.swing.JTextField();
        correoTextField = new javax.swing.JTextField();
        tituloPanel = new javax.swing.JPanel();
        tituloLabel = new javax.swing.JLabel();
        registrateLabel = new javax.swing.JLabel();
        contraseñaTextField = new javax.swing.JPasswordField();
        seleccionarRolComboBox = new javax.swing.JComboBox<>();
        rolLabel = new javax.swing.JLabel();
        botonesInferioresPanel = new javax.swing.JPanel();
        registrarButton = new javax.swing.JButton();
        loginButton = new javax.swing.JButton();
        volverAdminPanelButton = new javax.swing.JButton();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);

        UsuarioLabel.setFont(new java.awt.Font("Segoe UI Black", 0, 18)); // NOI18N
        UsuarioLabel.setText("Usuario");

        contraseñaLabel.setFont(new java.awt.Font("Segoe UI Black", 0, 18)); // NOI18N
        contraseñaLabel.setText("Contraseña");

        correoLabel.setFont(new java.awt.Font("Segoe UI Black", 0, 18)); // NOI18N
        correoLabel.setText("Correo");

        UsuarioTextField.setFont(new java.awt.Font("Segoe UI Black", 0, 14)); // NOI18N
        UsuarioTextField.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                UsuarioTextFieldActionPerformed(evt);
            }
        });

        correoTextField.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                correoTextFieldActionPerformed(evt);
            }
        });

        tituloPanel.setBackground(new java.awt.Color(51, 102, 255));

        tituloLabel.setFont(new java.awt.Font("Segoe UI Black", 0, 48)); // NOI18N
        tituloLabel.setText("REGISTRO");

        javax.swing.GroupLayout tituloPanelLayout = new javax.swing.GroupLayout(tituloPanel);
        tituloPanel.setLayout(tituloPanelLayout);
        tituloPanelLayout.setHorizontalGroup(
            tituloPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(tituloPanelLayout.createSequentialGroup()
                .addGap(124, 124, 124)
                .addComponent(tituloLabel)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );
        tituloPanelLayout.setVerticalGroup(
            tituloPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(tituloPanelLayout.createSequentialGroup()
                .addGap(52, 52, 52)
                .addComponent(tituloLabel)
                .addContainerGap(64, Short.MAX_VALUE))
        );

        registrateLabel.setFont(new java.awt.Font("Segoe UI", 1, 18)); // NOI18N
        registrateLabel.setText("Registrate en una nueva cuenta");

        contraseñaTextField.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                contraseñaTextFieldActionPerformed(evt);
            }
        });

        seleccionarRolComboBox.setFont(new java.awt.Font("Segoe UI Black", 0, 18)); // NOI18N
        seleccionarRolComboBox.setModel(new javax.swing.DefaultComboBoxModel<>(new String[] { "cliente", "admin" }));
        seleccionarRolComboBox.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                seleccionarRolComboBoxActionPerformed(evt);
            }
        });

        rolLabel.setFont(new java.awt.Font("Segoe UI Black", 0, 18)); // NOI18N
        rolLabel.setText("Rol:");

        registrarButton.setFont(new java.awt.Font("Segoe UI Black", 0, 18)); // NOI18N
        registrarButton.setText("Registrar");
        registrarButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                registrarButtonActionPerformed(evt);
            }
        });

        loginButton.setFont(new java.awt.Font("Segoe UI Black", 0, 18)); // NOI18N
        loginButton.setText("Login");
        loginButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                loginButtonActionPerformed(evt);
            }
        });

        volverAdminPanelButton.setFont(new java.awt.Font("Segoe UI Black", 0, 18)); // NOI18N
        volverAdminPanelButton.setText("Volver al Panel");
        volverAdminPanelButton.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseEntered(java.awt.event.MouseEvent evt) {
                volverAdminPanelButtonMouseEntered(evt);
            }
            public void mouseExited(java.awt.event.MouseEvent evt) {
                volverAdminPanelButtonMouseExited(evt);
            }
        });
        volverAdminPanelButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                volverAdminPanelButtonActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout botonesInferioresPanelLayout = new javax.swing.GroupLayout(botonesInferioresPanel);
        botonesInferioresPanel.setLayout(botonesInferioresPanelLayout);
        botonesInferioresPanelLayout.setHorizontalGroup(
            botonesInferioresPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(botonesInferioresPanelLayout.createSequentialGroup()
                .addGap(155, 155, 155)
                .addComponent(registrarButton, javax.swing.GroupLayout.PREFERRED_SIZE, 154, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
            .addGroup(botonesInferioresPanelLayout.createSequentialGroup()
                .addGap(25, 25, 25)
                .addComponent(loginButton, javax.swing.GroupLayout.PREFERRED_SIZE, 105, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addComponent(volverAdminPanelButton, javax.swing.GroupLayout.PREFERRED_SIZE, 183, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(26, 26, 26))
        );
        botonesInferioresPanelLayout.setVerticalGroup(
            botonesInferioresPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(botonesInferioresPanelLayout.createSequentialGroup()
                .addComponent(registrarButton, javax.swing.GroupLayout.PREFERRED_SIZE, 42, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(33, 33, 33)
                .addGroup(botonesInferioresPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(loginButton, javax.swing.GroupLayout.PREFERRED_SIZE, 41, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(volverAdminPanelButton, javax.swing.GroupLayout.PREFERRED_SIZE, 41, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addContainerGap(30, Short.MAX_VALUE))
        );

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(tituloPanel, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
            .addComponent(botonesInferioresPanel, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
            .addGroup(layout.createSequentialGroup()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createSequentialGroup()
                        .addGap(204, 204, 204)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(UsuarioLabel)
                            .addComponent(correoLabel)))
                    .addGroup(layout.createSequentialGroup()
                        .addGap(158, 158, 158)
                        .addComponent(seleccionarRolComboBox, javax.swing.GroupLayout.PREFERRED_SIZE, 145, javax.swing.GroupLayout.PREFERRED_SIZE)))
                .addGap(0, 0, Short.MAX_VALUE))
            .addGroup(layout.createSequentialGroup()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createSequentialGroup()
                        .addGap(105, 105, 105)
                        .addComponent(registrateLabel))
                    .addGroup(layout.createSequentialGroup()
                        .addGap(147, 147, 147)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING, false)
                            .addComponent(correoTextField, javax.swing.GroupLayout.Alignment.LEADING, javax.swing.GroupLayout.DEFAULT_SIZE, 180, Short.MAX_VALUE)
                            .addComponent(UsuarioTextField, javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(contraseñaTextField)))
                    .addGroup(layout.createSequentialGroup()
                        .addGap(184, 184, 184)
                        .addComponent(contraseñaLabel))
                    .addGroup(layout.createSequentialGroup()
                        .addGap(213, 213, 213)
                        .addComponent(rolLabel)))
                .addContainerGap(105, Short.MAX_VALUE))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addComponent(tituloPanel, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(38, 38, 38)
                .addComponent(registrateLabel)
                .addGap(35, 35, 35)
                .addComponent(UsuarioLabel)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(UsuarioTextField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(26, 26, 26)
                .addComponent(correoLabel)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(correoTextField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(38, 38, 38)
                .addComponent(contraseñaLabel)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(contraseñaTextField, javax.swing.GroupLayout.PREFERRED_SIZE, 22, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 33, Short.MAX_VALUE)
                .addComponent(rolLabel)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(seleccionarRolComboBox, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(36, 36, 36)
                .addComponent(botonesInferioresPanel, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void UsuarioTextFieldActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_UsuarioTextFieldActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_UsuarioTextFieldActionPerformed

    private void registrarButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_registrarButtonActionPerformed
        registrarUsuario();
    }//GEN-LAST:event_registrarButtonActionPerformed

    private void correoTextFieldActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_correoTextFieldActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_correoTextFieldActionPerformed

    private void contraseñaTextFieldActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_contraseñaTextFieldActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_contraseñaTextFieldActionPerformed

    private void loginButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_loginButtonActionPerformed
        this.dispose();
        Login nuevoLogin = new Login(null, true);
        nuevoLogin.setVisible(true);
    }//GEN-LAST:event_loginButtonActionPerformed

    private void seleccionarRolComboBoxActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_seleccionarRolComboBoxActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_seleccionarRolComboBoxActionPerformed

    private void volverAdminPanelButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_volverAdminPanelButtonActionPerformed
        this.dispose();
        AdminPanel adminPanel = new AdminPanel(null, true);
        adminPanel.setVisible(true);
    }//GEN-LAST:event_volverAdminPanelButtonActionPerformed

    private void volverAdminPanelButtonMouseEntered(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_volverAdminPanelButtonMouseEntered
        volverAdminPanelButton.setBackground(moradoAdmin);
    }//GEN-LAST:event_volverAdminPanelButtonMouseEntered

    private void volverAdminPanelButtonMouseExited(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_volverAdminPanelButtonMouseExited
        volverAdminPanelButton.setBackground(originalBackgroundColor);
    }//GEN-LAST:event_volverAdminPanelButtonMouseExited

    /**
     * @param args the command line arguments
     */
    public static void main(String args[]) {
        /* --- CÓDIGO PARA INICIAR FLATLAF --- */
        try {
            // Usamos el tema Darcula que ya habías seleccionado
            FlatDarculaLaf.setup();
        } catch (Exception ex) {
            System.err.println("No se pudo inicializar el Look and Feel FlatLaf.");
        }
        /* --- FIN DEL CÓDIGO DE FLATLAF --- */


 /* Creamos y mostramos la ventana UNA SOLA VEZ */
        java.awt.EventQueue.invokeLater(new Runnable() {
            @Override
            public void run() {
                Registro dialog = new Registro(new javax.swing.JFrame(), true);
                dialog.addWindowListener(new java.awt.event.WindowAdapter() {
                    @Override
                    public void windowClosing(java.awt.event.WindowEvent e) {
                        System.exit(0);
                    }
                });
                dialog.setVisible(true);
            }
        });
    }
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JLabel UsuarioLabel;
    private javax.swing.JTextField UsuarioTextField;
    private javax.swing.JPanel botonesInferioresPanel;
    private javax.swing.JLabel contraseñaLabel;
    private javax.swing.JPasswordField contraseñaTextField;
    private javax.swing.JLabel correoLabel;
    private javax.swing.JTextField correoTextField;
    private javax.swing.JButton loginButton;
    private javax.swing.JButton registrarButton;
    private javax.swing.JLabel registrateLabel;
    private javax.swing.JLabel rolLabel;
    private javax.swing.JComboBox<String> seleccionarRolComboBox;
    private javax.swing.JLabel tituloLabel;
    private javax.swing.JPanel tituloPanel;
    private javax.swing.JButton volverAdminPanelButton;
    // End of variables declaration//GEN-END:variables
}
